#!/bin/bash

# Security check script for CVE-2025-55182 (React2Shell)
# This script checks if the repository contains vulnerable React Server or Next.js packages

# Note: We don't use 'set -e' because grep commands are expected to fail when no matches are found
set -o pipefail

echo "üîç Checking for CVE-2025-55182 (React2Shell) vulnerabilities..."
echo ""

VULNERABLE=false

# Define vulnerable versions
VULNERABLE_REACT_VERSIONS=("19.0.0" "19.1.0" "19.1.1" "19.2.0")
PATCHED_REACT_VERSIONS=("19.0.1" "19.1.2" "19.2.1")

# Function to check if a version is vulnerable
is_vulnerable_react() {
    local version=$1
    for v in "${VULNERABLE_REACT_VERSIONS[@]}"; do
        if [[ "$version" == "$v" ]]; then
            return 0
        fi
    done
    return 1
}

# Function to check package.json files
check_package_json() {
    file=$1
    echo "Checking $file..."
    
    # Check for Next.js (disable exit on grep failures)
    if grep -q '"next"' "$file" 2>/dev/null; then
        next_version=$(grep '"next"' "$file" 2>/dev/null | sed 's/.*"next".*"\([^"]*\)".*/\1/' | tr -d '^~' || echo "unknown")
        if [[ "$next_version" != "unknown" && ! -z "$next_version" ]]; then
            echo "  ‚ö†Ô∏è  Found Next.js dependency: $next_version"
            echo "     Please verify this version is not vulnerable (14.3.0-canary.77+, 15.x, or 16.x)"
            VULNERABLE=true
        fi
    fi
    
    # Check for react-server-dom
    if grep -q 'react-server-dom' "$file" 2>/dev/null; then
        echo "  ‚ö†Ô∏è  Found react-server-dom package"
        VULNERABLE=true
    fi
    
    # Check for React version
    if grep -q '"react"' "$file" 2>/dev/null; then
        react_version=$(grep '"react"' "$file" 2>/dev/null | grep -v 'react-dom\|react-router\|react-icons' | head -1 | sed 's/.*"react".*"\([^"]*\)".*/\1/' | tr -d '^~' || echo "")
        if [[ ! -z "$react_version" ]]; then
            # Extract major version (handle non-numeric versions gracefully)
            major_version=$(echo "$react_version" | cut -d. -f1 | grep -o '[0-9]*' || echo "0")
            if [[ "$major_version" == "19" ]]; then
                if is_vulnerable_react "$react_version"; then
                    echo "  ‚ùå VULNERABLE: React version $react_version"
                    VULNERABLE=true
                else
                    echo "  ‚úÖ React version $react_version (appears safe)"
                fi
            elif [[ "$major_version" =~ ^[0-9]+$ ]] && [[ "$major_version" -gt 0 ]]; then
                echo "  ‚úÖ React version $react_version (not affected)"
            fi
        fi
    fi
}

# Find all package.json files (excluding node_modules)
while IFS= read -r -d '' file; do
    check_package_json "$file"
done < <(find . -name "package.json" -not -path "*/node_modules/*" -print0)

echo ""

# Check yarn.lock files for installed versions
if [ -f "yarn.lock" ] || [ -f "ui/yarn.lock" ] || [ -f "bot/dashboard/yarn.lock" ]; then
    echo "üîç Checking lock files for installed React versions..."
    
    for lockfile in yarn.lock ui/yarn.lock bot/dashboard/yarn.lock; do
        if [ -f "$lockfile" ]; then
            echo "Checking $lockfile..."
            
            # Check for react-server-dom in lock file (disable exit on grep failures)
            if grep -q "react-server-dom" "$lockfile" 2>/dev/null; then
                echo "  ‚ö†Ô∏è  Found react-server-dom in $lockfile"
                VULNERABLE=true
            fi
            
            # Check for Next.js in lock file
            if grep -q "^next@" "$lockfile" 2>/dev/null; then
                echo "  ‚ö†Ô∏è  Found Next.js installation in $lockfile"
                VULNERABLE=true
            fi
            
            # Check actual installed React version
            installed_react=$(grep -A 2 '^react@.*:$' "$lockfile" 2>/dev/null | grep 'version' | head -1 | sed 's/.*version "\([^"]*\)".*/\1/' || echo "")
            if [[ ! -z "$installed_react" ]]; then
                major=$(echo "$installed_react" | cut -d. -f1 | grep -o '[0-9]*' || echo "0")
                if [[ "$major" == "19" ]]; then
                    if is_vulnerable_react "$installed_react"; then
                        echo "  ‚ùå VULNERABLE: Installed React $installed_react"
                        VULNERABLE=true
                    else
                        echo "  ‚úÖ Installed React $installed_react (appears safe)"
                    fi
                elif [[ "$major" =~ ^[0-9]+$ ]] && [[ "$major" -gt 0 ]]; then
                    echo "  ‚úÖ Installed React $installed_react (not affected)"
                fi
            fi
        fi
    done
fi

echo ""
echo "================================================"

if [ "$VULNERABLE" = true ]; then
    echo "‚ùå SECURITY ALERT: Potential CVE-2025-55182 vulnerability detected!"
    echo ""
    echo "Action required:"
    echo "1. If using React 19.x, upgrade to patched versions:"
    echo "   - React 19.0.1, 19.1.2, or 19.2.1+"
    echo "2. If using Next.js, upgrade to patched versions:"
    echo "   - 14.3.0-canary.88, 15.0.5, 15.1.9, 15.2.6, 15.3.6, 15.4.8, 15.5.7, or 16.0.7+"
    echo "3. Review the security advisory: docs/SECURITY-CVE-2025-55182.md"
    echo ""
    exit 1
else
    echo "‚úÖ No CVE-2025-55182 vulnerabilities detected"
    echo ""
    echo "Repository is safe from React2Shell vulnerability."
    echo "All React installations are using non-vulnerable versions."
    echo ""
    exit 0
fi
