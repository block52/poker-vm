name: poker-vm
services:
    # PVM (Poker Virtual Machine) Backend
    pvm:
        build:
            context: ./pvm/ts
            dockerfile: Dockerfile
        container_name: pvm-backend
        restart: unless-stopped
        environment:
            PORT: 8545
            PUBLIC_URL: ${PUBLIC_URL:-http://localhost:8545}
            PK: ${PK:-}
            SEED: ${SEED:-}
        ports:
            - "8545:8545"
        volumes:
            # For development hot reload
            - ./pvm/ts:/app:cached
            - /app/node_modules
            - /app/dist
        networks:
            - poker-network
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8545/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    # Frontend UI
    frontend:
        build:
            context: ./ui
            dockerfile: Dockerfile
        container_name: pvm-frontend
        restart: unless-stopped
        environment:
            VITE_PROJECT_ID: ${VITE_PROJECT_ID:-23ec57c1c95f3f54a97605975d4df7eb}
            VITE_NODE_RPC_URL: http://localhost:8545
            VITE_NODE_WS_URL: ws://localhost:8545
            VITE_MAINNET_RPC_URL: ${VITE_MAINNET_RPC_URL:-https://mainnet.infura.io/v3/}
            VITE_CLUB_NAME: ${VITE_CLUB_NAME:-Block 52}
            VITE_CLUB_LOGO: ${VITE_CLUB_LOGO:-}
            VITE_FAVICON_URL: ${VITE_FAVICON_URL:-/b52favicon.svg}
            VITE_BRAND_COLOR_PRIMARY: ${VITE_BRAND_COLOR_PRIMARY:-#3b82f6}
            VITE_BRAND_COLOR_SECONDARY: ${VITE_BRAND_COLOR_SECONDARY:-#1a2639}
        ports:
            - "5173:5173" # Use standard Vite port
        depends_on:
            pvm:
                condition: service_healthy
        volumes:
            # For development hot reload
            - ./ui:/app:cached
            - /app/node_modules
        networks:
            - poker-network
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:5173"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    # Proxy Server (API Gateway)
    proxy:
        build:
            context: ./proxy/js
            dockerfile: Dockerfile
        container_name: pvm-proxy
        restart: unless-stopped
        environment:
            PORT: 8080
            NODE_URL: ${NODE_URL:-https://node1.block52.xyz}
            PVM_URL: http://pvm:8545
        ports:
            - "8080:8080"
        depends_on:
            pvm:
                condition: service_healthy
        networks:
            - poker-network
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

networks:
    poker-network:
        driver: bridge
